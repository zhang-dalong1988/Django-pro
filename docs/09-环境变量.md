# 第九章：环境变量

环境变量是可以在运行时加载到项目操作环境中的变量，而不是硬编码到代码库本身。它们被认为是流行的十二因子应用设计方法论的重要组成部分，也是 Django 的最佳实践，因为它们提供了更高级别的安全性和更简单的本地/生产配置。

为什么安全性更高？因为我们可以将真正的机密信息（数据库凭据、API 密钥等）与实际代码库分开存储。这是一个好主意，因为使用版本控制系统（如 git）意味着只需要一次错误的提交就可能将凭据永远添加到其中。这意味着任何有权访问代码库的人都可以完全控制项目。这是非常非常危险的。最好限制谁可以访问应用程序，环境变量提供了一种优雅的方式来做到这一点。

第二个优势是环境变量使在本地和生产代码环境之间切换变得更加容易。正如我们将看到的，Django 默认使用许多设置配置，旨在使本地开发更容易，但一旦同一项目准备好用于生产，就必须更改这些配置。

## 1. Environs

在 Python 中有许多不同的方法来处理环境变量，但对于这个项目，我们将使用 `environs` 包，它有一个 Django 特定的选项，可以安装许多有助于配置的附加包。

我们将首先更新 `requirements.txt` 文件来安装它。

```txt
asgiref==3.5.2
Django==4.0.4
psycopg2-binary==2.9.3
sqlparse==0.4.2
django-crispy-forms==1.14.0
crispy-bootstrap5==0.6
django-allauth==0.50.0
environs[django]==9.5.0
```

然后关闭当前运行的 Docker 容器，重新构建包含新软件包的 Docker 镜像，并再次启动容器。

**Shell**

```bash
$ docker-compose down
$ docker-compose up -d --build
```

在 `django_project/settings.py` 文件中，在 Path 导入的正下方，在文件顶部添加三行导入。

```python
# django_project/settings.py

from pathlib import Path
from environs import Env  # 新增

env = Env()  # 新增
env.read_env()  # 新增
```

全部设置完成。

## 2. SECRET_KEY

对于我们的第一个环境变量，我们将设置 `SECRET_KEY`，这是一个用于加密签名的随机生成字符串，在运行 `startproject` 命令时创建。非常重要的是 `SECRET_KEY` 实际上要保持秘密。

在我的 `django_project/settings.py` 文件中，它具有以下值：

```python
# django_project/settings.py

SECRET_KEY = "django-insecure-hv1(e0r@v4n4m6gqdz%dn(60o=dsy8&@0_lbs8p-v3u^bs4)xl"
```

请注意，`SECRET_KEY` 周围的双引号（""）使其成为 Python 字符串。双引号实际上不是 `SECRET_KEY` 值本身的一部分，这是一个容易犯的错误。

切换到环境变量有一个两步过程：

1. 将环境变量添加到 `docker-compose.yml` 文件
2. 更新 `django_project/settings.py` 以指向该变量

在 `docker-compose.yml` 文件中，在 web 服务下添加一个名为 `environment` 的部分。它将是一个我们称为 `DJANGO_SECRET_KEY` 的变量，其值为我们现有的 `SECRET_KEY`。更新后的文件如下所示：

**docker-compose.yml**

```yaml
version: "3.9"

services:
  web:
    build: .
    command: python /code/manage.py runserver 0.0.0.0:8000
    volumes:
      - .:/code
    ports:
      - 8000:8000
    depends_on:
      - db
    environment:
      - "DJANGO_SECRET_KEY=django-insecure-hv1(e0r@v4n4m6gqdz%dn(60o=dsy8&@0_lbs8p-v3u^bs4)xl"
  db:
    image: postgres:13
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - "POSTGRES_HOST_AUTH_METHOD=trust"

volumes:
  postgres_data:
```

请注意，如果您的 `SECRET_KEY` 包含美元符号 `$`，那么您需要添加一个额外的美元符号 `$$`。这是由于 docker-compose 处理变量替换的方式。否则您会看到错误！

第二步是更新 `django_project/settings.py` 中的 `SECRET_KEY` 配置。

**代码**

```python
# django_project/settings.py

SECRET_KEY = env("DJANGO_SECRET_KEY")
```

如果您现在刷新网站，您可能会看到错误。Django 需要 `SECRET_KEY` 才能工作，在这种情况下，我们的值存储在 `docker-compose.yml` 中，用于启动容器。在我们重新启动当前容器之前，它不会被应用，我们现在就这样做。

**Shell**

```bash
$ docker-compose down
$ docker-compose up -d
```

再次刷新页面，一切都像以前一样工作，这正是我们想要的。敏锐的读者可能会注意到，即使我们现在使用环境变量，`SECRET_KEY` 的实际值在我们的源代码中仍然可见，因为它只是移动到了由 Git 跟踪的 `docker-compose.yml`。这是真的！但是，当我们为生产配置网站时，我们将为生产目的创建一个单独的文件 `docker-compose-production.yml`，并立即将其添加到我们的 `.gitignore` 文件中，这样它就不会在源代码中被跟踪。

不过现在，本章的目标是开始在本地使用环境变量来处理需要真正保密或在生产环境中切换的值。

## 3. DEBUG 和 ALLOWED_HOSTS

正如 Django 部署检查清单所指出的，在网站可以安全地部署到生产环境之前，必须更新许多设置。其中最重要的是 `DEBUG` 和 `ALLOWED_HOSTS`。

当 `DEBUG` 设置为 `True` 时，Django 在发生错误时会显示冗长的消息和详细的错误报告。例如，尝试访问不存在的页面，如 `http://127.0.0.1:8000/debug`。

这对我们作为开发人员的目的来说很棒，但在生产环境中，这也是黑客的路线图。当 `DEBUG` 设置为 `False` 时，需要添加 `ALLOWED_HOSTS` 设置，该设置控制可以访问网站的特定主机或域。我们将添加两个本地端口 `localhost` 和 `127.0.0.1`，以及 `.herokuapp.com`，这将被 Heroku 用于我们的生产网站。

使用两个新设置更新 `django_project/settings.py` 文件：

```python
# django_project/settings.py

DEBUG = False  # 新增
ALLOWED_HOSTS = [".herokuapp.com", "localhost", "127.0.0.1"]  # 新增
```

然后刷新网页。

这是我们生产站点想要的行为：没有信息，只是一个通用消息。当我们部署网站时，我们将使用一种优雅的方式在两个设置之间切换，但现在将 `DEBUG` 更改为名为 `DJANGO_DEBUG` 的环境变量。

```python
# django_project/settings.py

DEBUG = env.bool("DJANGO_DEBUG")  # 新增
```

然后继续更新 `docker-compose.yml`，使 `DJANGO_DEBUG` 设置为 `True`。

**docker-compose.yml**

```yaml
version: "3.9"

services:
  web:
    build: .
    command: python /code/manage.py runserver 0.0.0.0:8000
    volumes:
      - .:/code
    ports:
      - 8000:8000
    depends_on:
      - db
    environment:
      - "DJANGO_SECRET_KEY=django-insecure-hv1(e0r@v4n4m6gqdz%dn(60o=dsy8&@0_lbs8p-v3u^bs4)xl"
      - "DJANGO_DEBUG=True"
  db:
    image: postgres:13
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - "POSTGRES_HOST_AUTH_METHOD=trust"

volumes:
  postgres_data:
```

更改后刷新您网站的主页，它将像以前一样工作。一切都正常工作。

## 4. DATABASES

当我们之前安装 `environs[django]` 时，Django "好东西" 包括了优雅的 `dj-database-url` 包，它获取我们数据库所需的所有数据库配置，SQLite 或 PostgreSQL。这在以后的生产中会非常有帮助。

现在，我们可以通过添加默认值将其设置为在本地使用 PostgreSQL。使用以下内容更新现有的 `DATABASES` 配置：

**代码**

```python
# django_project/settings.py

DATABASES = {
    "default": env.dj_db_url("DATABASE_URL",
                           default="postgres://postgres@db/postgres")
}
```

环境变量 `DATABASE_URL` 将在我们部署时由 Heroku 创建。稍后会详细介绍。刷新网站以确认一切仍然正常工作。

## 5. Git

我们在本章中做了许多重要的更改，所以确保使用 Git 提交代码更新。

**Shell**

```bash
$ git status
$ git add .
$ git commit -m 'ch9'
```

如果出现任何问题，请将您的文件与 Github 上的官方源代码进行比较。

## 6. 结论

添加环境变量是任何真正专业的 Django 项目的必要步骤。它们需要一些时间来适应，但对于在本地和生产环境之间切换是无价的，我们将在本书的后面部分进行。在下一章中，我们将完全配置我们的电子邮件设置并添加密码重置功能。
