# Django 表单

## 1. 表单基础

### 1.1 什么是 Django 表单

Django 表单是一个强大的工具，用于：
- 生成 HTML 表单
- 验证用户输入
- 将表单数据转换为 Python 数据类型
- 处理表单错误

### 1.2 创建基本表单

```python
# forms.py
from django import forms

class ContactForm(forms.Form):
    name = forms.CharField(max_length=100)
    email = forms.EmailField()
    message = forms.CharField(widget=forms.Textarea)
    
    def clean_email(self):
        email = self.cleaned_data['email']
        if not email.endswith('@example.com'):
            raise forms.ValidationError('邮箱必须是 @example.com 域名')
        return email
```

### 1.3 在视图中使用表单

```python
# views.py
from django.shortcuts import render, redirect
from .forms import ContactForm

def contact_view(request):
    if request.method == 'POST':
        form = ContactForm(request.POST)
        if form.is_valid():
            # 处理表单数据
            name = form.cleaned_data['name']
            email = form.cleaned_data['email']
            message = form.cleaned_data['message']
            # 保存或发送邮件等操作
            return redirect('success')
    else:
        form = ContactForm()
    
    return render(request, 'contact.html', {'form': form})
```

### 1.4 模板中渲染表单

```html
<!-- contact.html -->
<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">提交</button>
</form>

<!-- 或者手动渲染 -->
<form method="post">
    {% csrf_token %}
    <div>
        {{ form.name.label_tag }}
        {{ form.name }}
        {% if form.name.errors %}
            <div class="error">{{ form.name.errors }}</div>
        {% endif %}
    </div>
    <div>
        {{ form.email.label_tag }}
        {{ form.email }}
        {% if form.email.errors %}
            <div class="error">{{ form.email.errors }}</div>
        {% endif %}
    </div>
    <div>
        {{ form.message.label_tag }}
        {{ form.message }}
        {% if form.message.errors %}
            <div class="error">{{ form.message.errors }}</div>
        {% endif %}
    </div>
    <button type="submit">提交</button>
</form>
```

## 2. 表单字段类型

### 2.1 常用字段

```python
from django import forms

class ExampleForm(forms.Form):
    # 文本字段
    char_field = forms.CharField(max_length=100)
    text_field = forms.CharField(widget=forms.Textarea)
    
    # 数字字段
    integer_field = forms.IntegerField()
    decimal_field = forms.DecimalField(max_digits=10, decimal_places=2)
    float_field = forms.FloatField()
    
    # 选择字段
    CHOICES = [
        ('option1', '选项1'),
        ('option2', '选项2'),
    ]
    choice_field = forms.ChoiceField(choices=CHOICES)
    multiple_choice = forms.MultipleChoiceField(choices=CHOICES)
    
    # 布尔字段
    boolean_field = forms.BooleanField()
    
    # 日期时间字段
    date_field = forms.DateField()
    datetime_field = forms.DateTimeField()
    time_field = forms.TimeField()
    
    # 文件字段
    file_field = forms.FileField()
    image_field = forms.ImageField()
    
    # 邮箱和URL
    email_field = forms.EmailField()
    url_field = forms.URLField()
```

### 2.2 字段参数

```python
class DetailedForm(forms.Form):
    name = forms.CharField(
        max_length=100,
        min_length=2,
        required=True,
        label='姓名',
        help_text='请输入您的真实姓名',
        initial='默认值',
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': '请输入姓名'
        })
    )
```

## 3. ModelForm

### 3.1 基于模型的表单

```python
# models.py
from django.db import models

class Book(models.Model):
    title = models.CharField(max_length=200)
    author = models.CharField(max_length=100)
    isbn = models.CharField(max_length=13)
    publication_date = models.DateField()
    price = models.DecimalField(max_digits=10, decimal_places=2)
    description = models.TextField()
    
    def __str__(self):
        return self.title

# forms.py
from django import forms
from .models import Book

class BookForm(forms.ModelForm):
    class Meta:
        model = Book
        fields = ['title', 'author', 'isbn', 'publication_date', 'price', 'description']
        # 或者排除某些字段
        # exclude = ['created_at']
        
        widgets = {
            'publication_date': forms.DateInput(attrs={'type': 'date'}),
            'description': forms.Textarea(attrs={'rows': 4}),
        }
        
        labels = {
            'title': '书名',
            'author': '作者',
            'isbn': 'ISBN',
            'publication_date': '出版日期',
            'price': '价格',
            'description': '描述',
        }
        
        help_texts = {
            'isbn': '请输入13位ISBN号码',
        }
```

### 3.2 ModelForm 视图

```python
# views.py
from django.shortcuts import render, redirect, get_object_or_404
from .models import Book
from .forms import BookForm

def create_book(request):
    if request.method == 'POST':
        form = BookForm(request.POST)
        if form.is_valid():
            book = form.save()
            return redirect('book_detail', pk=book.pk)
    else:
        form = BookForm()
    
    return render(request, 'books/create.html', {'form': form})

def edit_book(request, pk):
    book = get_object_or_404(Book, pk=pk)
    if request.method == 'POST':
        form = BookForm(request.POST, instance=book)
        if form.is_valid():
            form.save()
            return redirect('book_detail', pk=book.pk)
    else:
        form = BookForm(instance=book)
    
    return render(request, 'books/edit.html', {'form': form, 'book': book})
```

## 4. 表单验证

### 4.1 字段级验证

```python
class UserRegistrationForm(forms.Form):
    username = forms.CharField(max_length=30)
    email = forms.EmailField()
    password = forms.CharField(widget=forms.PasswordInput)
    confirm_password = forms.CharField(widget=forms.PasswordInput)
    
    def clean_username(self):
        username = self.cleaned_data['username']
        if User.objects.filter(username=username).exists():
            raise forms.ValidationError('用户名已存在')
        return username
    
    def clean_email(self):
        email = self.cleaned_data['email']
        if User.objects.filter(email=email).exists():
            raise forms.ValidationError('邮箱已被注册')
        return email
```

### 4.2 表单级验证

```python
class UserRegistrationForm(forms.Form):
    # ... 字段定义 ...
    
    def clean(self):
        cleaned_data = super().clean()
        password = cleaned_data.get('password')
        confirm_password = cleaned_data.get('confirm_password')
        
        if password and confirm_password:
            if password != confirm_password:
                raise forms.ValidationError('两次输入的密码不一致')
        
        return cleaned_data
```

### 4.3 自定义验证器

```python
from django.core.exceptions import ValidationError

def validate_even_number(value):
    if value % 2 != 0:
        raise ValidationError('必须是偶数')

class NumberForm(forms.Form):
    even_number = forms.IntegerField(validators=[validate_even_number])
```

## 5. 表单集 (Formsets)

### 5.1 基本表单集

```python
from django.forms import formset_factory

class ArticleForm(forms.Form):
    title = forms.CharField()
    pub_date = forms.DateField()

ArticleFormSet = formset_factory(ArticleForm, extra=2)

def manage_articles(request):
    if request.method == 'POST':
        formset = ArticleFormSet(request.POST)
        if formset.is_valid():
            for form in formset:
                # 处理每个表单
                pass
    else:
        formset = ArticleFormSet()
    
    return render(request, 'articles.html', {'formset': formset})
```

### 5.2 模型表单集

```python
from django.forms import modelformset_factory

BookFormSet = modelformset_factory(Book, fields=('title', 'author'), extra=1)

def manage_books(request):
    if request.method == 'POST':
        formset = BookFormSet(request.POST)
        if formset.is_valid():
            formset.save()
    else:
        formset = BookFormSet(queryset=Book.objects.none())
    
    return render(request, 'books.html', {'formset': formset})
```

## 6. 内联表单集

```python
from django.forms import inlineformset_factory

# 假设有 Author 和 Book 模型，Book 有外键指向 Author
BookInlineFormSet = inlineformset_factory(
    Author, Book, 
    fields=('title', 'publication_date'), 
    extra=1
)

def edit_author(request, author_id):
    author = get_object_or_404(Author, pk=author_id)
    if request.method == 'POST':
        formset = BookInlineFormSet(request.POST, instance=author)
        if formset.is_valid():
            formset.save()
    else:
        formset = BookInlineFormSet(instance=author)
    
    return render(request, 'edit_author.html', {
        'author': author,
        'formset': formset
    })
```

## 7. CSRF 保护

### 7.1 启用 CSRF 保护

```python
# settings.py
MIDDLEWARE = [
    # ...
    'django.middleware.csrf.CsrfViewMiddleware',
    # ...
]
```

### 7.2 在模板中使用

```html
<form method="post">
    {% csrf_token %}
    <!-- 表单字段 -->
</form>
```

### 7.3 Ajax 请求中的 CSRF

```javascript
// 获取 CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// 在 Ajax 请求中使用
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});
```

## 8. 文件上传

### 8.1 文件上传表单

```python
class FileUploadForm(forms.Form):
    title = forms.CharField(max_length=50)
    file = forms.FileField()
    
    def clean_file(self):
        file = self.cleaned_data['file']
        if file.size > 5 * 1024 * 1024:  # 5MB
            raise forms.ValidationError('文件大小不能超过5MB')
        return file
```

### 8.2 处理文件上传

```python
def upload_file(request):
    if request.method == 'POST':
        form = FileUploadForm(request.POST, request.FILES)
        if form.is_valid():
            # 处理上传的文件
            uploaded_file = request.FILES['file']
            # 保存文件
            with open(f'uploads/{uploaded_file.name}', 'wb+') as destination:
                for chunk in uploaded_file.chunks():
                    destination.write(chunk)
    else:
        form = FileUploadForm()
    
    return render(request, 'upload.html', {'form': form})
```

### 8.3 模板中的文件上传

```html
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">上传</button>
</form>
```

## 9. 表单样式和自定义

### 9.1 使用 Bootstrap 样式

```python
class StyledForm(forms.Form):
    name = forms.CharField(
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': '请输入姓名'
        })
    )
    email = forms.EmailField(
        widget=forms.EmailInput(attrs={
            'class': 'form-control',
            'placeholder': '请输入邮箱'
        })
    )
```

### 9.2 自定义 Widget

```python
class DatePickerWidget(forms.DateInput):
    def __init__(self, attrs=None):
        default_attrs = {'class': 'datepicker'}
        if attrs:
            default_attrs.update(attrs)
        super().__init__(attrs=default_attrs, format='%Y-%m-%d')

class EventForm(forms.Form):
    event_date = forms.DateField(widget=DatePickerWidget())
```

## 10. 表单最佳实践

### 10.1 表单组织

```python
# forms/
# ├── __init__.py
# ├── user_forms.py
# ├── book_forms.py
# └── contact_forms.py

# user_forms.py
from django import forms
from django.contrib.auth.models import User

class UserProfileForm(forms.ModelForm):
    class Meta:
        model = User
        fields = ['first_name', 'last_name', 'email']
```

### 10.2 表单测试

```python
# tests.py
from django.test import TestCase
from .forms import ContactForm

class ContactFormTest(TestCase):
    def test_valid_form(self):
        form_data = {
            'name': 'Test User',
            'email': 'test@example.com',
            'message': 'Test message'
        }
        form = ContactForm(data=form_data)
        self.assertTrue(form.is_valid())
    
    def test_invalid_email(self):
        form_data = {
            'name': 'Test User',
            'email': 'invalid-email',
            'message': 'Test message'
        }
        form = ContactForm(data=form_data)
        self.assertFalse(form.is_valid())
        self.assertIn('email', form.errors)
```

### 10.3 性能优化

```python
# 使用 select_related 优化查询
class BookForm(forms.ModelForm):
    class Meta:
        model = Book
        fields = '__all__'
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # 优化外键字段的查询
        self.fields['author'].queryset = Author.objects.select_related('publisher')
```

## 11. 常见问题和解决方案

### 11.1 表单不显示错误

确保在模板中显示错误：

```html
{% if form.errors %}
    <div class="alert alert-danger">
        {{ form.errors }}
    </div>
{% endif %}
```

### 11.2 CSRF 验证失败

确保：
- 在表单中包含 `{% csrf_token %}`
- CSRF 中间件已启用
- Ajax 请求包含 CSRF token

### 11.3 文件上传失败

确保：
- 表单使用 `enctype="multipart/form-data"`
- 视图中传递 `request.FILES`
- 设置正确的文件上传路径和权限

## 总结

Django 表单提供了强大的功能来处理用户输入，包括：
- 自动 HTML 生成
- 数据验证
- 错误处理
- CSRF 保护
- 文件上传
- 与模型的集成

掌握这些概念和技巧，可以构建安全、高效的 Web 表单。